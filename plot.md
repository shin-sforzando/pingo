# Pingo

AIによる画像判定を用いたビンゴゲームの再発明。
友人や家族との集まり、イベント、教育現場など、様々な場面で使用できるエンターテイメントツール。

## 機能概要

### ゲームのルール

- 5x5のマス目を持つビンゴゲーム、中央のFreeを除く24マスには「赤い車」「工事現場の看板」「笑っている人」などの被写体の候補となる単語が並ぶ
- ゲーム参加者はそれらのマスに対してスマートフォンで写真を撮ってアップロード
- アップロードされた画像をAIが判定し、該当する被写体のマスがあったらOPENする
  - AIがどのように写真を解釈したかを毎回ユーザに提示し返すことで、写真の撮り方を徐々に工夫してもらう
- 撮影とアップロードを繰り返し、通常のビンゴ同様に列を揃えることを目指す

### ユーザ

ユーザは「プレイヤー」「ゲーム作成者」「ゲーム管理者」「ゲーム参加者」の4種の概念で整理する。

#### プレイヤー

- プレイヤー登録は"ハンドルネーム"と"パスワード"を必須とし、実名や性別、メールアドレスは求めない
- 登録時に用いたハンドルネームとパスワードを用いたログイン/ログアウト
  - 参加の障壁をなるべく下げるのと、個人情報をシステムが持たないで済むようにするため
- プレイヤー登録時にシステム内ではUUIDv4でプレイヤーIDを発番し、Firestoreで管理
- ハンドルネームはシステム内でユニークでなければならない
  - ユニークであるならば後から変更することも可能とする

#### ゲーム作成者

- ログインしていれば誰でもゲームを作成できる
- ゲームを作成（詳細については後述）すると自動的にそのゲームの管理者および参加者となる

#### ゲーム管理者

- ゲーム作成者およびゲーム作成者から権限を付与されたゲーム参加者はゲーム管理者となる
- ゲーム管理者は以下のゲームの状況をリアルタイムにモニターすることができる
  - ゲームへの参加者の人数
  - ゲームに対して提出された写真
  - 参加者ごとの写真提出数
  - 参加者ごとのビンゴ達成数
- ゲーム管理者はゲームの有効期限を変更することができる
  - 変更したとしても、ゲーム作成時から最長で1週間とする
- ゲーム管理者はゲームの有効期限を待たずにゲームを終了させ、新規ゲーム参加者の受付および写真の提出を止めることができる
- ゲーム管理者はゲームの公開/非公開状態を切り替えることができる

### ゲームの作成

- ゲームは作成されるとアルファベット大文字6桁（例 `ABCDEF` ）のユニークなIDが発番される
  - ユーザに直接入力されることを考慮し、小文字や数字は使わない
- ゲーム作成時に「場所またはテーマ」、「難易度」などを入力することで、どのような被写体が良いかLLMが24個プラスアルファの候補を提案
  - 被写体は画像判定AIが判定しやすいものでなければならないので、候補生成プロンプトに工夫が必要
- ゲーム作成者はLLMによって提案された候補に加えて、自身で考案（自由入力）した候補を並び替えて最終的な24個のマスと配置を決定
  - 自由入力した候補が画像判定AIによって判定できそうかを検討するとともに、公序良俗に反する内容でないかもLLMに再チェックさせる
- ゲームごとに「何列揃えたらゴールとするか」（デフォルトは1列）を設定
- ゲーム作成時に「提出された写真の共有」可否を選択し、「共有」になっている場合は、ゲーム参加者が互いの提出した写真をゲーム中およびゲーム後に見ることができるようになる
  - 写真共有可能となったゲームはゲーム参加時に「このゲームで提出した写真は他のユーザも見ることができます」と注意喚起する必要あり
- ゲーム作成時にゲームの公開/非公開を選択
  - 「公開」されたゲームはゲーム参加画面の公開ゲーム一覧に列挙される
- ゲーム作成時にゲームの有効期限（最長で1週間、最短で1時間、デフォルトで24時間）を設定する
- ゲーム作成時にゲーム参加者も読むことのできる「備考」を設定することができる

### ゲームの共有

- ゲームの作成に成功すると、ゲームごとのユニークなURLにアクセスできるQRコードが表示される
- ゲームに参加するにはQRコードを読み取るか、ゲーム参加画面でゲームIDを直接入力するか、公開ゲームの一覧から選択する

#### ゲームへの参加

- ログインしているプレイヤーはゲームIDの入力や公開ゲームの一覧からの選択を以てゲームに参加できる
  - プレイヤーは同時に複数のゲームに参加できる
  - プレイヤーは自分が参加している、または参加していたゲームの履歴を一覧、選択できる

#### ゲーム中

- ゲーム参加者はゲームごとに写真の提出可能回数は30回とし、自分があと何回提出できるかを常時確認できる
  - 提出可能回数に制限を設けるのは画像判定AIの濫用を防ぐため
- 写真の提出時にクライアント側で画像のJPG化とリサイズを行い、画像判定AIに適した画像にしてからアップロードする
  - 提出できる画像の形式はJPG、PNG、HEICとし、動画やライブ写真は選択できないようにする
- ゲームが写真共有可能と設定されていた場合、ゲーム参加者は自分が提出した写真も含め、他の参加者がどのような写真を提出しているかを閲覧することができる
- ビンゴの列を揃えると、揃えた時間がサーバ側にも記録され、画面にも表示される
- 設定された列数を揃えるとゴール演出が表示される

### ゲームの終了と結果

- ゲームごとの有効期限を迎えたか、管理者によって終了されたゲームは写真選択ができなくなる
- 指定した列数を揃えた参加者の名前と揃えた日時が表彰される
- ゲームが写真共有可能と設定されていた場合、ゲームに参加していたプレイヤーは終了後もゲームに対して提出された画像を閲覧することができる

## 技術スタック

- Docker -> Google Cloud Run
- Node.js 22
  - Next.js (App Router)
    - TypeScript 5
    - React 19
    - Tailwind CSS 4
  - Biome.js
  - Storybook
  - Vitest
- Lefthook

- ストレージ: Google Cloud Storage
- データベース: Firestore
- ゲーム作成時の候補列挙: Google Gemini API
- 提出された画像の判定: Google Gemini API

## UI

ゲームの性質上、スマートフォンでの利用を主眼とし、解像度の小さい環境でも問題なく遊べるように十分配慮する。
対象ユーザには子どもや高齢者を含むため、極端に小さなフォントなどは使用を避ける。
全体的に可愛らしいトーン&マナーとしたいので、ダークモードはあえて用意しない。
カラーパレットとして、以下の4色を基本構成色とする。

- #08d9d6
- #252a34
- #ff2e63
- #eaeaea

### 画面

#### `/`

トップページ。
Pingoの概要を説明。
ログインしていれば `/new` と `/join` へのリンクを表示し、ログインしていなければ `/register` への遷移を促す。

#### `/register`

ユーザの新規登録画面。
ハンドルネーム、パスワードの入力と利用規約への同意を求める。

#### `/[userId]`

#### `/[userId]/edit`

ハンドルネーム、パスワードの編集。

#### `/new`

ゲームの新規作成画面。
ゲーム設定を入力し、「AIによって候補を生成」すると被写体候補が列挙される。
ビンゴカードが常時プレビュー表示されている。

#### `/join`

ゲームへの参加画面。
ゲームIDの直接入力に加えて、自身が参加しているゲームの最新10件と公開ゲームの最新10件を表示。
当該ゲーム画面に遷移する前にビンゴカードのプレビューとゲームの詳細を表示し、本当に参加するかを確認する。

#### `/game/[gameId]`

ゲーム画面。
ゲームのタイトルや作者、有効期限といったゲームの概要が表示され、その下に進行中のビンゴカード、さらにその下に画像の提出フォーム。
画像をアップロードした際のLLMからの応答は画像提出フォーム下部に表示される。
最下部に当該ゲームに参加している他のプレイヤーのハンドルネームなど最上部で表示しなかったゲームの詳細情報。

#### `/game/[gameId]/share`

ゲームの共有画面。
ゲームの作成が成功した際に自動的に遷移する。
ゲームの詳細とQRコードが表示される。

#### `/game/[gameId]/result`

ゲーム結果確認画面。
終了したゲームの `/game/[gameId]` にアクセスした際に自動的に遷移。
一方、終了していないゲームに対して `/game/[gameId]/result` にアクセスした場合は `/game/[gameId]` へリダイレクト。
ゲームの詳細とビンゴカードのプレビュー、自分が提出した画像に加え、写真共有可能なゲームだった場合には他のユーザによって提出された画像も表示。

#### `/game/[gameId]/admin`

ゲームの管理画面。
管理者になっていないゲームに対してアクセスした場合は `/game/[gameId]` へリダイレクト。
ゲームの詳細情報を表示し、有効期限や公開/非公開が編集できる。
ゲームの進捗情報をリアルタイムに更新。

#### `/privacy`

プライバシーポリシー。
具体的な文面は検討中だが、複数のデプロイ先によって切り替える可能性あり。
（例えば、企業タイアップした場合など、基本文面に加えて、各企業の文面を追加するなど）

#### `/terms`

サービス利用規約。
文面は検討中だが、複数のデプロイ先によって切り替える可能性あり。
（プライバシーポリシー同様、企業タイアップした場合など、基本文面に加えて、各企業の文面を追加するなど）

#### `/contact`

運営会社への連絡フォーム。

#### `/error`

何らかのエラーが生じた場合に遷移し、エラーの詳細を表示する。

#### `/config`

システム管理者だけがアクセスできるシステム管理ページ。
システム管理パスワードで認証。
詳細は追って検討。

#### `/health`

Cloud Runのヘルスチェック向けページ。
Node.js、Next.js、Reactなど主要ライブラリのバージョン情報とCPU割り当て、メモリ使用量などのリソース情報。

### コンポーネント

分割統治を意識し、それぞれのコンポーネントが部品として様々な組み合わせに耐えるよう設計したい。
`Button` や `InputField` などシステム内のあちこちで使われる基本コンポーネントに加え、以下、現時点で必要になるだろうと考えている複合コンポーネントの例。

#### Header

システム名 `Pingo` を中央に配置し、右上にハンバーガーメニュー
ハンバーガーメニューから「ログイン/ログアウト」、「ハンドルネームの編集」「参加履歴の閲覧」「提出写真の一覧」

#### Footer

Copyright表記に加えて、 `/privacy` `/terms` `contact` へのリンク。

#### Notification Toast

システムからの通知を表示するトースト。
指定時間後にフェードアウト。
指定時間を待たずに消すためのクローズボタン付き。

「ログインしました」「ログアウトしました」「ゲーム XXXXXX が作成されました」「ゲーム XXXXXX に参加しました」「ゲーム XXXXXX の管理者になりました」「"赤い車"が"名無しの権兵衛"によって初めてOPENになりました」などを想定。

#### Image pop-up

ビンゴの列をそろえた時や、提出した画像が合格した場合、または不合格だった場合に最前面に表示されるポップアップ。
指定時間後にフェードアウト。
指定時間を待たずに消すためのクローズボタン付き。

「Bingo!」「Clear!」「OK！」「NG！」などを想定。

余力があれば、ブラウザのVibration APIを使って振動でも提示したい。

#### User Register

ユーザ登録に必要な情報を入力するフォーム群。

#### User Login/Logout

ログインに必要な情報を入力するフォーム群。

#### Bingo Cell

ビンゴのマス目に相当するコンポーネント。
「撮影すべき被写体」を表示する。
初期状態の `CLOSE` と、達成済みの `OPEN` 、5x5中央に配置される `FREE` （ビンゴゲームにおける扱いとしては `OPEN` と同等）などの状態を持つ。
`OPEN` では、判定し合格となった画像が背景になる。

ゲームが写真共有可能と設定されていた場合は、押下することで、そのセルに対して合格した自分または他のプレイヤーの画像らをグリッド表示する。
つまり、そのセルを `OPEN` した他のプレイヤーがいるかをほぼリアルタイムに監視し、存在する場合は `HINTED` のような状態にする必要がある。

#### Bingo Board

Bingo Cellを5x5に配置。
`OPEN` 状態で縦、横、斜めにそろった列があればその列を強調表示。

#### Image Submit

ゲーム参加者が画像を提出するためのフォーム。
画像を選択または撮影後にプレビューされると良い。

#### Image Grid

Bingo Cell押下時やゲーム終了後など、複数の画像を一覧するためのコンポーネント。
グリッド上にサムネイルを並べ、サムネイルを押下すると拡大表示する。

#### Subject Card

ゲーム作成時に被写体候補を編集するためのフォーム。
LLMによって挙げられた候補で初期化されたり、新規に作成されたり削除されたりする。
後述のリスト表示にて、ビンゴカードに`採用される` `採用されない` の2状態を持つ必要がある。
加えて、入力された被写体候補が公序良俗に反するような場合に `このままでは採用できない` という状態もあり得る。

#### Subjects List

Subject Cardを並べたリスト。
上記24件（5x5の中央のFreeを除くので）がBingo Cellになる `採用される` 状態となる。
並べ替えはドラッグ&ドロップでできると望ましい。
`採用される` Subject Cardが24件に満たない場合は警告表示する。

#### Game ID Input

アルファベット大文字6桁からなるゲームIDを入力するフォーム。
6文字入力であることがわかりやすいUIとなっているべき。
6文字入力したタイミングで、そのゲームが参加可能かをバリデーションし、参加不可能（ゲームが存在しない、ゲームが終了している等）で警告表示。

#### Game Card

ゲーム参加画面やプレイヤーごとの参加履歴にて、ゲームを列挙する際の各アイテム。
ゲームのタイトル、ゲームID、ゲームの状態、作者、作成日時、有効期限、備考などのゲームの概要を表示する。
ゲームの状態に応じて色味が変わる。
押下することで、そのゲーム画面に遷移する。

#### Game List

Game Cardを並べたリスト。
タイトルや作成日時、状態などでソートできると良い。

#### Game Detail

ゲーム中、またはゲーム管理画面にてゲームの詳細情報を表示するためのコンポーネント。
Game Cardより詳細な情報を表示する。
自身がそのゲームの管理者に含まれる場合は管理画面へのリンクが表示される。

#### Players List

ゲーム中に参加者の一覧を表示する際に使用するコンポーネント。
自身が管理者の場合は、参加者を選択して管理者に加えることができる。

#### QR Code

ゲームごとに生成されたURLへの遷移を助けるQRコード表示。
主にゲームの新規作成が成功した際に利用される。

#### Speech Bubble

新規ゲーム作成時にLLMがどのように候補を推測したか、または画像判定AIが提出された画像をどのように解釈したか、などを表示する吹き出し。
「AIからの応答」を統一的なUIで提供する。
LLMからの応答はMarkdownである可能性が高いので、Markdownをそのままレンダリングできると良い。

## API

**T. B. D.**

## データモデル

**T. B. D.**

## ストレージ設計

Google Cloud Storageの階層機能を活用し、ゲームIDごとにフォルダを分けて画像を保存することでImage Listなどで列挙する際のクエリを効率化したい。

## 非機能要件

### 想定環境

スマートフォンからの利用がほとんどであり、特に日本においてはiPhoneからのアクセスが多いと想定。
よって、iOS Safariでの完全動作は必須。
次点でAndroid Chromeとし、現行から過去3年程度までの機種およびブラウザをカバーしたい。

### 多言語対応

日英の2ヶ国語対応とする。
デフォルトロケールは日本語とする。
日本語は他の言語と比べて比較的サイズを取る傾向があるため、日本語で破綻しないUIを作成することで、英語対応が楽になると期待する。

### セキュリティ

本システムではそもそも個人情報を扱わないが、データベースへの書き込み処理はAPIを介してサーバ側に集約するなどを意識して行う。
恐るべきは、ストレージやAIを目的外に濫用されることであり、APIキーの流出などはあってはならない。

### 演出

エンターテイメントアプリなので、アニメーションやトランジションが使えるところは積極的に使っていく。
一方、ブラウザアプリであり、どのような環境で利用されるかも想定しきれないため、BGMや効果音は用意しない。

## 開発管理

まずは1ヶ月後の6月末を目安にMVPの完成を目指し、MVPの完成をマイルストーン「Version 1.0」と呼称する。
Version 1.0の時点で、自動テストのカバレッジは70%を目標とする。

全てのタスクはGitHub Issueで管理され、着手優先度に応じて、Version 0.8、0.9、1.0、1.1、2.0を設定する。
マイルストーンはすでにGitHub上に準備済み。
GitHubのIssue Templateは `.github/ISSUE_TEMPLATE/feat.md` `.github/ISSUE_TEMPLATE/fix.md` に用意した。

## 要検討事項

- しばらくはCloud Runから発行されるURLを本番環境URLとし、将来的にはドメインを取得、設定したい
- CI/CDについて、GitHub mainブランチへのPushをトリガーに動くGoogle Cloud Buildを用意してCloud Runにデプロイ
- デプロイ以外の自動テストや静的解析にはGitHub Actionsを活用したい
- データモデルの定義にはZodを利用したほうが良いか
- 状態管理はReact Context APIで良いか
- バナー広告を掲載し、クラウド利用料の足しにしたい
- Google Analyticsを導入し、アクセス解析を行いたい

## 備考

初版: 2025/04/26
