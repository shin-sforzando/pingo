# 進捗状況

## 現在の状態

Pingoプロジェクトは現在、機能実装段階に入っています。基礎構築が完了し、ゲーム作成機能と画像投稿機能の実装が完了しました。

> [!NOTE]
> 詳細な要件や設計の情報については、 `./cline_docs/TechnicalSpecification.md` を参照してください。
> 過去の開発履歴については、 `./cline_docs/Archived_20250514.md` を参照してください。

## 最近の変更

- **画像投稿機能の実装**
  - ImageUploadコンポーネントの実装
    - ドラッグ&ドロップによる画像選択
    - ファイル形式・サイズの検証（JPEG、PNG、HEIC、HEIF、WebP対応）
    - HEICファイルの完全対応（MIMEタイプ + 拡張子検証）
    - HEICファイルのプレビュー表示（変換後のJPEGで表示）
    - クライアントサイドでの画像処理（リサイズ・圧縮・JPEG変換）
    - アップロード進行状況の表示
    - 包括的なエラーハンドリング
  - 画像処理ユーティリティの実装
    - 自動リサイズ（最大1280px）
    - JPEG形式への変換と圧縮（品質80%）
    - HEIC/HEIF→JPEG変換（heic2anyライブラリ使用）
    - 動的インポートによるSSR対応
    - ファイルサイズ最適化（最大20MB）
  - Google Cloud Storage連携
    - 署名付きURLによる直接アップロード
    - CORS設定対応
    - 技術仕様準拠のストレージ設計: `{gameId}/{userId}_{submissionId}.jpg`
    - セキュアな署名付きURL（5分間有効）
  - Gemini AI画像内容チェック
    - gemini-2.0-flash-001モデルによる自動判定
    - 公序良俗チェック（性的・暴力的内容の検出）
    - 適切性判定結果の表示
    - 不適切画像の自動拒否
    - 正しいAPI実装（公式ドキュメント準拠）
  - APIエンドポイントの実装
    - `/api/image/getUploadUrl`: 署名付きアップロードURL生成
    - `/api/image/check`: Gemini AIによる画像内容検証
    - Firebase Authentication連携
    - 詳細なエラーハンドリングとログ出力
  - テスト環境の構築
    - `/debug/image-upload`: 機能テスト用の専用ページ
    - 詳細なログ出力とエラーハンドリング
    - アップロード結果の詳細表示
  - 動作確認完了
    - JPEG、PNG、WebP画像のアップロード
    - HEICファイルの検証、変換、プレビュー、アップロード
    - 画像処理（リサイズ・圧縮）
    - Google Cloud Storageへのアップロード
    - Gemini AIによる画像内容チェック（「✅ Yes」表示確認済み）

- データ変換とバリデーションの改善
  - APIエンドポイントの修正
    - `src/app/api/game/[gameId]/board/route.ts`、`src/app/api/game/[gameId]/route.ts`、`src/app/api/game/[gameId]/participants/route.ts`の修正
    - `gameFromFirestore`、`gameBoardFromFirestore`、`userFromFirestore`関数を使用したFirestoreデータの適切な変換
    - Timestamp型のフィールドをDateオブジェクトに正しく変換
  - サービス層の改善
    - `src/services/game.ts`にConverterとZodバリデーションを組み合わせた堅牢なアプローチを実装
    - 2段階のデータ処理：Converterによる変換とZodスキーマによるバリデーション
    - バリデーションエラーが発生した場合でも、変換されたデータを返しつつエラーをログに記録
    - 型安全性と値の制約の両方を確保
  - SharePageの機能強化
    - 公開ゲームの場合はQRコードを表示
    - 非公開ゲームの場合は「Game ID: {gameId}」を表示
    - Storybookに`PublicGame`と`PrivateGame`の2つのストーリーを追加
  - ローディングUIの改善
    - `src/app/loading.tsx`の実装
    - `HyperText`コンポーネントを使用したアニメーションテキスト
    - SharePageのローディング表示も同様のスタイルに統一

- ヘッダーコンポーネントの拡張
  - UserMenuコンポーネントの実装
    - ユーザー名の1文字目を丸く囲ったAvatarの表示
    - ドロップダウンメニューの実装（プロフィールリンク、言語切り替え、参加中ゲーム一覧、ログアウト）
    - 認証状態に応じた表示切り替え
  - NotificationIconコンポーネントの実装
    - 通知アイコンの表示と未読通知の強調表示
    - 通知ドロワーの表示機能
  - NotificationDrawerコンポーネントの拡張
    - ダミー通知データの表示
    - 通知メッセージの多言語対応
    - 未読/既読状態の視覚的表現
  - 翻訳キーの追加
    - すべてのNotificationType列挙型に対応する翻訳キーの追加
    - Header関連の翻訳キーの追加
- ゲーム新規作成画面および機能の実装
  - ゲーム作成フォームの実装
    - タイトル、テーマの入力フィールド
    - 被写体候補リストの編集機能
    - ビンゴボードのプレビュー表示
  - 被写体候補リスト管理コンポーネントの実装
    - SubjectItemコンポーネント（文字列入力、削除ボタン、採用/非採用状態表示）
    - SubjectListコンポーネント（ドラッグ＆ドロップ並び替え、新規追加ボタン）
    - 最初から24個の被写体候補を表示する機能
  - ビンゴボードプレビューコンポーネントの実装
    - 5x5グリッドの表示
    - 中央のFREEセルの表示
    - 被写体候補の変更に応じたリアルタイム更新
  - 多言語対応（日英）の実装
    - 翻訳キーの追加と適用
    - プレースホルダーの翻訳
  - Hydrationエラーの修正
    - useIdを使用した安定したID生成
    - サーバーとクライアントで一貫したレンダリング
  - フォーム送信とボタン操作の改善
    - type="button"属性の追加によるリダイレクト問題の解決
    - エラーハンドリングの強化
  - デバッグ機能の追加
    - 認証状態の確認
    - APIレスポンスのログ出力
- Google Gemini APIとの連携
  - 被写体候補生成API（`/api/subjects/generate`）の実装
    - タイトルとテーマに基づいた被写体候補の生成
    - 言語設定（日本語/英語）に応じた候補の生成
    - ユーザーのロケール設定の考慮
    - 公序良俗に反するタイトルやテーマのチェック
    - エラーハンドリングとレスポンス処理
  - 被写体候補チェックAPI（`/api/subjects/check`）の実装
    - 被写体候補が以下の条件を満たすかチェック：
      1. 具体的な名詞または短い記述的フレーズであること
      2. 写真で視覚的に識別可能であること
      3. Google Cloud Vision AIで認識可能であること
      4. プレイヤーが何を撮影すべきか理解できるよう、曖昧さが少ないこと
      5. 全年齢向けであること（不適切なコンテンツを含まない）
      6. リスト内で重複していないこと
    - 言語設定（日本語/英語）に応じたチェック
    - ユーザーのロケール設定の考慮
    - 問題がある場合は、問題のある被写体とその理由を返す
  - 包括的なテストの実装
    - 入力バリデーションのテスト
    - 言語設定のテスト（日本語と英語の両方）
    - 公序良俗チェックのテスト（日本語と英語の両方）
    - 抽象的な概念、曖昧な表現、不適切なコンテンツ、重複項目のテスト
    - 生成APIとチェックAPIの統合テスト
- ゲーム作成画面の機能強化
  - 「候補を生成」ボタンの挙動改善
    - 複数回押下時に新しい候補が末尾に追加されるように修正
    - 完全重複する文字列は追加しないように対応（バッチ内の重複も除外）
    - Magic UIのShine Borderを使用した生成中の視覚的フィードバックの実装
    - 生成中であることを示すメッセージの追加
  - 被写体候補の管理機能強化
    - 被写体候補をリセットするボタンの追加
    - 被写体候補の数を表示するテキストの追加
    - 「ゲームを作成」ボタン押下時のみ`/api/subjects/check`を呼び出すよう修正
    - 問題のある被写体にエラーメッセージを表示する機能の追加
    - ビンゴボードに使用される最初の24個の被写体候補のみをチェックするよう最適化
  - 認証関連の修正
    - Firebase Authenticationから取得したIDトークンを使用するよう修正
  - テストとStorybookの追加
    - テストファイルの更新と全テストの正常実行確認
    - ゲーム作成ページのStorybookの作成
    - ShineBorderコンポーネントのStorybookの作成（様々な設定のバリエーションを表示）
- テストファイルの改善
  - `page.browser.test.tsx`の修正
    - モックユーザーをULID形式に修正し、必要なプロパティを追加
    - `vi.hoisted`を使用してモック関数を定義し、巻き上げ問題を解決
    - `LoginForm`と`RegisterForm`のモックを改善し、`data-testid`属性を追加
    - テストケースを修正し、より具体的なセレクタを使用
    - すべてのテストが正常に実行されることを確認

## 次のステップ

優先度に基づいて、以下の順序で開発を進めていきます：

### 画像投稿機能の改善（優先度：高）

- **デバッグログの削除とエラーハンドリング改善**（本番対応）
  - `console.log`の削除
  - ユーザーフレンドリーなエラーメッセージの実装
  - エラー時の詳細情報の改善
- **テストの追加**（品質保証）
  - Gemini API部分の自動テスト
  - エラーケースのテスト
  - 統合テストの追加
- **パフォーマンス最適化**（ユーザー体験向上）
  - 大きな画像ファイルの処理時間改善
  - メモリ使用量の最適化
  - プログレス表示の改善
- **セキュリティ強化**
  - レート制限の実装
  - ファイル内容の詳細検証
  - APIキーの適切な管理

### その他の機能実装

- 認証済みユーザーのみがアクセスできるページの保護
- 基本コンポーネントの実装と拡充
  - ゲーム参加フォーム
    - QRコード表示
    - ゲームID（6桁）入力
    - 公開かつ有効なゲームの一覧表示
- Firebaseとの連携
  - ゲームデータの保存と取得
  - ユーザーデータの管理

## アクティブな決定事項と検討事項

### 画像投稿機能の改善点

#### 🚨 気になる点・改善の余地

1. **テストの不足**
   - 現在、実際の動作テストが不十分
   - 自動テストがない（特にGemini API部分）
   - エラーケースのテストが不足

2. **エラーハンドリングの改善余地**
   - デバッグログが本番環境に残る
   - エラー時の詳細情報が不足
   - ユーザーフレンドリーなエラーメッセージが不足

3. **パフォーマンスの最適化**
   - 大きな画像ファイルの処理時間
   - メモリ使用量の最適化
   - プログレス表示の改善

4. **セキュリティの強化**
   - レート制限の実装
   - ファイル内容の詳細検証
   - APIキーの適切な管理

5. **ユーザビリティの向上**
   - アップロード進行状況の詳細表示
   - キャンセル機能
   - 複数ファイル対応

6. **コードの整理**
   - 一部のハードコーディング
   - 型定義の改善
   - コメントの充実

7. **国際化の完成**
   - エラーメッセージの多言語対応
   - AI判定結果の多言語対応

#### 優先度の判断

**現在の状態:** 基本機能は動作するが、本格運用には改善が必要

**最優先で修正すべき点:**

1. デバッグログの削除
2. エラーハンドリングの改善
3. テストの追加

### 検討中の事項

現時点では、画像投稿機能の改善点以外に主要な検討事項はありません。今後の開発過程で新たな検討事項が発生した場合は、ここに追加していきます。

## 残りの作業

### 画像投稿機能関連

- デバッグログの削除とエラーハンドリング改善
- 自動テストの追加
- パフォーマンス最適化
- セキュリティ強化

### その他の機能

- ゲーム参加機能の実装
- ゲーム画面の実装
- リアルタイム機能の実装

## 既知の問題

### 画像投稿機能

- 本番環境用のデバッグログが残存
- エラーメッセージの多言語対応が不完全
- 大きなファイルの処理パフォーマンス
- レート制限の未実装

### テストが不十分なファイル

- **`src/components/game/ImageUpload.tsx`**
  - 自動テストが存在しない
  - エラーケースのテスト不足
  - HEICファイル処理のテスト不足
  - ドラッグ&ドロップ機能のテスト不足

- **`src/lib/image-utils.ts`**
  - 基本的なテストは存在するが不十分
  - HEIC変換のエラーケーステスト不足
  - 大きなファイルの処理テスト不足
  - メモリ使用量のテスト不足

- **`src/services/image-upload.ts`**
  - 自動テストが存在しない
  - ネットワークエラーのテスト不足
  - 認証エラーのテスト不足
  - タイムアウトのテスト不足

- **`src/app/api/image/getUploadUrl/route.ts`**
  - 自動テストが存在しない
  - 認証失敗のテスト不足
  - バリデーションエラーのテスト不足
  - Firebase Admin SDKエラーのテスト不足

- **`src/app/api/image/check/route.ts`**
  - 自動テストが存在しない
  - Gemini APIエラーのテスト不足
  - 画像取得失敗のテスト不足
  - レスポンス解析エラーのテスト不足

- **`src/app/api/image/upload/route.ts`**
  - 自動テストが存在しない
  - 統合テストが不足
  - エラーハンドリングのテスト不足

- **APIエンドポイント全般**
  - 統合テストが不足
  - エラーケースのテスト不足
  - パフォーマンステストが不足

### その他

- T. B. D.
