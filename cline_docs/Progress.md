# 進捗状況

## 現在の状態

Pingoプロジェクトは現在、機能実装段階に入っています。基礎構築が完了し、ゲーム作成機能と画像投稿機能の実装が完了しました。

> [!NOTE]
> 詳細な要件や設計の情報については、 `./cline_docs/TechnicalSpecification.md` を参照してください。
> 過去の開発履歴については、 `./cline_docs/Archived_20250514.md` を参照してください。

## 最近の変更

- ゲームメイン画面コンポーネント実装完了
  - SubmissionResultコンポーネントの実装
    - AI画像判定結果の詳細表示機能
    - 確信度バーとステータス表示
    - 承認/不承認の視覚的フィードバック
    - マッチしたセル情報の表示
  - GameInfoコンポーネントの実装
    - ゲーム設定の詳細表示
    - ステータス、有効期限、閾値などの情報表示
    - 公開/非公開、写真共有設定の表示
  - ParticipantsListコンポーネントの実装
    - 参加者の役割と進捗表示
    - 現在ユーザーのハイライト機能
    - 完了ライン数の表示
  - 画像分析APIの実装（`/api/game/[gameId]/submission/analyze`）
    - Gemini 2.0 Flash使用の画像分析機能
    - 利用可能セルとの照合処理
    - 確信度による自動判定
    - セル状態の自動更新機能
- APIリファクタリング
  - データアクセス層移行: 12個のAPIファイルを直接Firestore操作からデータアクセス層経由に移行
    - ゲームAPI（7ファイル）: `[gameId]`、`board`、`participants`、`playerBoard/[userId]`、`submission`、`submission/[submissionId]`、`events`
    - 認証API（5ファイル）: `login`、`register`、`me`、`update`、`logout`
  - `game/create`APIは複雑なトランザクション処理のため直接Firestore操作を維持
  - データアクセス層の実装（`src/lib/firebase/admin-collections.ts`）
    - `AdminGameService`: ゲームCRUD操作
    - `AdminGameParticipationService`: 参加者管理
    - `AdminSubmissionService`: 投稿処理
    - `AdminPlayerBoardService`: プレイヤーボード操作
    - `AdminEventService`: イベントログ
    - `AdminGameBoardService`: ゲームボード管理
    - `AdminUserService`: ユーザー操作（認証サポート付き）
    - `AdminBatchService`: 最適化されたバッチ操作
  - Firebase Admin SDK制約への対応
    - `.withConverter()`未サポートのため手動型変換を実装
  - APIレスポンス形式の統一
    - 全APIで`{success: boolean, data: T, error?: ErrorInfo}`形式を採用
  - 重要なバグ修正
    - ゲーム共有画面の`Cannot read properties of undefined (reading 'slice')`エラーを解決
    - `BingoBoard`コンポーネントでの`cells`プロパティのnull/undefined チェック追加
- Google GenAI構造化出力への移行
  - 技術的改善
    - `Type`インポートと`responseSchema`定義の追加
    - `responseMimeType: "application/json"`と`responseSchema`の設定
  - 保守性向上
- 画像投稿機能の実装
  - ImageUploadコンポーネントの実装
    - ファイル形式・サイズの検証（JPEG、PNG、HEIC、HEIF、WebP対応）
    - HEICファイルの完全対応（MIMEタイプ + 拡張子検証）
    - HEICファイルのプレビュー表示（変換後のJPEGで表示）
    - クライアントサイドでの画像処理（リサイズ・圧縮・JPEG変換）
    - アップロード進行状況の表示
  - 画像処理ユーティリティの実装
    - 自動リサイズ（最大1280px）
    - JPEG形式への変換と圧縮（品質80%）
    - HEIC/HEIF→JPEG変換（heic2anyライブラリ使用）
    - 動的インポートによるSSR対応
  - Google Cloud Storage連携
    - 署名付きURLによる直接アップロード
    - CORS設定対応
    - 技術仕様準拠のストレージ設計: `{gameId}/{userId}_{submissionId}.jpg`
    - セキュアな署名付きURL（5分間有効）
  - Gemini AI画像内容チェック
    - gemini-2.0-flash-001モデルによる自動判定
    - 公序良俗チェック（性的・暴力的内容の検出）
    - 適切性判定結果の表示
  - APIエンドポイントの実装
    - `/api/image/getUploadUrl`: 署名付きアップロードURL生成
    - `/api/image/check`: Gemini AIによる画像内容検証
    - Firebase Authentication連携
  - テスト環境の構築
    - `/debug/image-upload`: 機能テスト用の専用ページ
- ヘッダーコンポーネントの拡張
  - UserMenuコンポーネントの実装
  - NotificationIconコンポーネントの実装
  - NotificationDrawerコンポーネントの拡張
- ゲーム新規作成画面および機能の実装
  - ゲーム作成フォームの実装
    - タイトル、テーマの入力フィールド
    - 被写体候補リストの編集機能
    - ビンゴボードのプレビュー表示
  - 被写体候補リスト管理コンポーネントの実装
    - SubjectItemコンポーネント（文字列入力、削除ボタン、採用/非採用状態表示）
    - SubjectListコンポーネント（ドラッグ＆ドロップ並び替え、新規追加ボタン）
    - 最初から24個の被写体候補を表示する機能
  - ビンゴボードプレビューコンポーネントの実装
    - 5x5グリッドの表示
    - 中央のFREEセルの表示
    - 被写体候補の変更に応じたリアルタイム更新
  - 多言語対応（日英）の実装
    - 翻訳キーの追加と適用
    - プレースホルダーの翻訳
  - Hydrationエラーの修正
    - useIdを使用した安定したID生成
    - サーバーとクライアントで一貫したレンダリング
  - フォーム送信とボタン操作の改善
  - デバッグ機能の追加
    - 認証状態の確認
    - APIレスポンスのログ出力
- Google Gemini APIとの連携
  - 被写体候補生成API（`/api/subjects/generate`）の実装
    - タイトルとテーマに基づいた被写体候補の生成
    - 公序良俗に反するタイトルやテーマのチェック
  - 被写体候補チェックAPI（`/api/subjects/check`）の実装
    - 被写体候補が以下の条件を満たすかチェック：
      1. 具体的な名詞または短い記述的フレーズであること
      2. 写真で視覚的に識別可能であること
      3. Google Cloud Vision AIで認識可能であること
      4. プレイヤーが何を撮影すべきか理解できるよう、曖昧さが少ないこと
      5. 全年齢向けであること（不適切なコンテンツを含まない）
      6. リスト内で重複していないこと
    - 問題がある場合は、問題のある被写体とその理由を返す
- ゲーム作成画面の機能強化
  - 「候補を生成」ボタンの挙動改善
    - 複数回押下時に新しい候補が末尾に追加されるように修正
    - 完全重複する文字列は追加しないように対応（バッチ内の重複も除外）
    - Magic UIのShine Borderを使用した生成中の視覚的フィードバックの実装
    - 生成中であることを示すメッセージの追加
  - 被写体候補の管理機能強化
    - 被写体候補をリセットするボタンの追加
    - 被写体候補の数を表示するテキストの追加
    - 「ゲームを作成」ボタン押下時のみ`/api/subjects/check`を呼び出すよう修正
    - 問題のある被写体にエラーメッセージを表示する機能の追加
    - ビンゴボードに使用される最初の24個の被写体候補のみをチェックするよう最適化

## 次のステップ

優先度に基づいて、以下の順序で開発を進めていきます：

### ゲームメイン画面の実装（優先度：最高）

- ゲームメイン画面ページの作成（`/game/[gameId]`）
  - 上から順に以下のレイアウトで実装：
    1. ゲームタイトル
    2. ユーザごとのビンゴボード
    3. 画像アップロード（ImageUploadコンポーネント）
    4. 画像判定結果（SubmissionResultコンポーネント）
    5. ゲーム情報詳細（GameInfoコンポーネント）
    6. 参加者一覧（ParticipantsListコンポーネント）
  - 画像アップロード→Gemini分析→セル自動更新の統合フロー
  - リアルタイム更新機能（Firestoreリスナー）
  - 認証ガード（AuthGuardコンポーネント）

### 画像投稿機能の改善（優先度：高）

- デバッグログの削除とエラーハンドリング改善（本番対応）
  - ユーザーフレンドリーなエラーメッセージの実装
  - エラー時の詳細情報の改善
- テストの追加（品質保証）
  - Gemini API部分の自動テスト
  - エラーケースのテスト
  - 統合テストの追加
- パフォーマンス最適化（ユーザー体験向上）
  - 大きな画像ファイルの処理時間改善
  - メモリ使用量の最適化
  - プログレス表示の改善
- セキュリティ強化
  - レート制限の実装
  - ファイル内容の詳細検証
  - APIキーの適切な管理

### その他の機能実装

- 認証済みユーザーのみがアクセスできるページの保護
- 基本コンポーネントの実装と拡充
  - ゲーム参加フォーム
    - QRコード表示
    - ゲームID（6桁）入力
    - 公開かつ有効なゲームの一覧表示
- Firebaseとの連携
  - ゲームデータの保存と取得
  - ユーザーデータの管理

## アクティブな決定事項と検討事項

### 画像投稿機能の改善点

#### 🚨 気になる点・改善の余地

1. テストの不足
   - 現在、実際の動作テストが不十分
   - 自動テストがない（特にGemini API部分）
   - エラーケースのテストが不足
2. エラーハンドリングの改善余地
   - デバッグログが本番環境に残る
   - エラー時の詳細情報が不足
   - ユーザーフレンドリーなエラーメッセージが不足
3. パフォーマンスの最適化
   - 大きな画像ファイルの処理時間
   - メモリ使用量の最適化
   - プログレス表示の改善
4. セキュリティの強化
   - レート制限の実装
   - ファイル内容の詳細検証
   - APIキーの適切な管理
5. ユーザビリティの向上
   - アップロード進行状況の詳細表示
   - キャンセル機能
   - 複数ファイル対応
6. コードの整理
   - 一部のハードコーディング
   - 型定義の改善
   - コメントの充実
7. 国際化の完成
   - エラーメッセージの多言語対応
   - AI判定結果の多言語対応

#### 優先度の判断

現在の状態: 基本機能は動作するが、本格運用には改善が必要

最優先で修正すべき点:

1. デバッグログの削除
2. エラーハンドリングの改善
3. テストの追加

### 検討中の事項

現時点では、画像投稿機能の改善点以外に主要な検討事項はありません。今後の開発過程で新たな検討事項が発生した場合は、ここに追加していきます。

## 既知の問題

### 認証していないユーザの対策

ゲーム画面やゲーム作成画面を非認証ユーザがアクセスできてはいけない

### テストが不十分なファイル

- `src/components/game/ImageUpload.tsx`
  - 自動テストが存在しない
  - エラーケースのテスト不足
  - HEICファイル処理のテスト不足
  - ドラッグ&ドロップ機能のテスト不足

- `src/lib/image-utils.ts`
  - 基本的なテストは存在するが不十分
  - HEIC変換のエラーケーステスト不足
  - 大きなファイルの処理テスト不足
  - メモリ使用量のテスト不足

- `src/services/image-upload.ts`
  - 自動テストが存在しない
  - ネットワークエラーのテスト不足
  - 認証エラーのテスト不足
  - タイムアウトのテスト不足

- `src/app/api/image/getUploadUrl/route.ts`
  - 自動テストが存在しない
  - 認証失敗のテスト不足
  - バリデーションエラーのテスト不足
  - Firebase Admin SDKエラーのテスト不足

- `src/app/api/image/check/route.ts`
  - 自動テストが存在しない
  - Gemini APIエラーのテスト不足
  - 画像取得失敗のテスト不足
  - レスポンス解析エラーのテスト不足

- `src/app/api/image/upload/route.ts`
  - 自動テストが存在しない
  - 統合テストが不足
  - エラーハンドリングのテスト不足

- APIエンドポイント全般
  - 統合テストが不足
  - エラーケースのテスト不足
  - パフォーマンステストが不足

### Storybook 9系へのアップグレード
